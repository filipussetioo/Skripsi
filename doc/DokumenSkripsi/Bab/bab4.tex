\chapter{Perancangan}
\label{chap:perancangan}
Bab ini membahas perancangan untuk seluruh implementasi \textit{SharIF Judge} pada \textit{CodeIgniter 4}.

\section{Instalasi \textit{CodeIgniter 4}}
\textit{CodeIgniter 4} akan dilakukan instalasi menggunakan \textit{composer}. \textit{Composer} merupakan sebuah \textit{dependency manager} untuk PHP yang memungkinkan pengguna untuk melakukan instalasi seluruh kebutuhan untuk menjalankan program berbasis PHP. Instalasi akan dilakukan menggunakan sintaks sebagai berikut:

\begin{center}
\verb|composer create-project codeigniter4/appstarter SharIF-JudgeCI4|
\end{center}

Sintaks diatas akan mengunduh dan melakukan instalasi \textit{template} projek \textit{CodeIgniter 4}.

\section{Perubahan Struktur Aplikasi}
\label{sec:perubahanStruktur}
Struktur aplikasi \textit{SharIF Judge} akan dipindahkan seperti pemetaan pada bab \ref{chap:analisis} gambar \ref{fig:dirMapping}. 
\\
Struktur aplikasi pada \textit{CodeIgniter 4} akan berisikan sebagai berikut :
\subsection{app/Config}
File \textit{config} pada \textit{CodeIgniter 3} akan dipindahkan sesuai dengan pemetaan pada gambar. Direktori berisikan data-data pada \texttt{application/Config}. Beberapa data pada direktori ini akan dipindahkan menuju file yang terdapat pada \textit{CodeIgniter 4}. Terdapat juga penambahan \textit{file} \texttt{Secrets.php} yang dibentuk secara manual. Berikut merupakan rincian isi direktori yang dipindahkan:
\subsubsection{\texttt{App.php}}
File ini tidak akan digunakan sehingga akan dibiarkan kosong dan seluruh data akan dipindahkan menuju file \texttt{.env}. Kode \ref{kode:envfileapp} merupakan isi dari file \texttt{.env} yang dipindahkan dari direktori \texttt{application/config}:

\begin{lstlisting}[caption= Kode \texttt{application/config/config.php} yang dipindahkan menuju \texttt{.env}, label=kode:envfileapp]
	app.baseURL = 'http://sharif.localhost/'
\end{lstlisting}

Kode \ref{kode:envfileapp} akan menentukan \textit{url} dasar dari aplikasi menjadi \texttt{http://sharif.localhost/}.

\subsubsection{\texttt{Autoload.php}}
File ini tidak akan digunakan karena pada \textit{CodeIgniter 3} tidak mengikuti standar pada PSR-4. Sedangkan pada \textit{CodeIgniter 4} mengikuti standar PSR-4 sehingga dapat melakukan inisiasi terhadap sebuah kelas menggunakan sintaks \texttt{new Kelas}. Beberapa kelas yang diinisiasi pada file ini akan dipindahkan menuju \texttt{BaseController} dan juga akan dipanggil menggunakan PSR-4 pada file-file yang menggunakan kelas tersebut.

\subsubsection{\texttt{Cache.php}}
File ini tidak terdapat perubahan karena akan tetap menggunakan konfigurasi \textit{default}.

\subsubsection{\texttt{Constant.php}}
File ini akan berisikan seluruh data yang dipindahkan dari \texttt{application/config/constants.php}. Kode  \ref{kode:constantbab4}.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Constant}, label=kode:constantbab4]
define('SHJ_VERSION','1.4');

define('FILE_READ_MODE', 0644);
define('FILE_WRITE_MODE', 0666);
define('DIR_READ_MODE', 0755);
define('DIR_WRITE_MODE', 0777);

define('FOPEN_READ', 'rb');
define('FOPEN_READ_WRITE', 'r+b');
define('FOPEN_WRITE_CREATE_DESTRUCTIVE', 'wb'); // truncates existing file data, use with care
define('FOPEN_READ_WRITE_CREATE_DESTRUCTIVE', 'w+b'); // truncates existing file data, use with care
define('FOPEN_WRITE_CREATE', 'ab');
define('FOPEN_READ_WRITE_CREATE', 'a+b');
define('FOPEN_WRITE_CREATE_STRICT', 'xb');
define('FOPEN_READ_WRITE_CREATE_STRICT', 'x+b');

/*Code editor related constants*/
define('EDITOR_FILE_NAME', "editor");
define('EDITOR_FILE_EXT', "txt");
define('EDITOR_IN_NAME', "exec_in");
define('EDITOR_OUT_NAME', "exec_out");
define('EDITOR_SUBMIT_ID', 0);
\end{lstlisting}

Kode \ref{kode:constantbab4} merupakan pemindahan dari \texttt{application/config/constants.php} menuju \texttt{Constant.php}. Sintaks yang telah dipindahkan akan bersifat \textit{global} sehingga dapat diakses oleh seluruh file pada \textit{CodeIgniter 4}.

\subsubsection{\texttt{Cookie.php}}
File ini tidak terdapat perubahan karena akan tetap menggunakan konfigurasi \textit{default}.

\subsubsection{\texttt{Databases.php}}
File ini tidak akan digunakan karena akan dipindahkan menuju file \texttt{.env}. Kode \ref{kode:databaseenvbab4} merupakan pemindahan menuju file \texttt{.env}.

\begin{lstlisting}[caption=Pemindahan \texttt{app/config/database.php} menuju \texttt{.env}, label=kode:databaseenvbab4]
database.default.hostname = db
database.default.database = pndevworks_project
database.default.username = root
database.default.password = 
database.default.DBDriver = MySQLi
database.default.DBPrefix = shj_
\end{lstlisting}

Kode \ref{kode:databaseenvbab4} merupakan pemindahan kode dari \texttt{database.php} menuju \texttt{.env}. Kode akan berisikan \textit{hostname} yang digunakan, nama \textit{database} yang digunakan, \textit{username} dari \textit{database}, \textit{password}, \textit{DBDriver}, dan \textit{DBPrefix} yang digunakan.

\subsubsection{\texttt{Email.php}}
File ini akan berisikan seluruh data yang dipindahkan dari \texttt{application/config/secrets.php}. Kode \ref{kode:emailconfigbab4} merupakan pemindahan konfigurasi \textit{email}.

\begin{lstlisting}[caption=Pemindahan \texttt{app/config/secrets.php} menuju \texttt{Email.php}, label=kode:emailconfigbab4]
    public string $protocol = 'smtp';
    public string $SMTPHost = 'ssl://smtp.mailgun.org';
    public string $mailType = 'html';
\end{lstlisting}

Kode \ref{kode:emailconfigbab4} merupakan pemindahan konfigurasi \textit{email} yang terdapat pada \texttt{secrets.php}. Kode akan berisikan \textit{protocol} yang digunakan untuk mengirim \textit{email}, \textit{host} yang akan digunakan, dan tipe \textit{email} yang dikirimkan. Seluruh data akan disimpan menuju variabel pada \textit{CodeIgniter 4}.

\subsubsection{\texttt{Encryption.php}}
File ini akan berisikan seluruh data yang dipindahkan dari \texttt{application/config/config.php}. Kode \ref{kode:encryptionbab4} merupakan pemindahan konfigurasi enkripsi yang akan digunakan.

\begin{lstlisting}[caption=Pemindahan \texttt{app/config/config.php} menuju \texttt{Encryption.php}, label=kode:encryptionbab4]
    public string $key = 'bj42CAiqTwLHUhz3pOvfRM0EJFeQD9uG';
\end{lstlisting}

Kode \ref{kode:encryptionbab4} merupakan pemindahan \textit{key} dari enkripsi yang akan digunakan. Data akan disimpan menuju variabel pada \textit{CodeIgniter 4}.

\subsubsection{\texttt{Filters.php}}
\label{subsubsec:filters}
File ini berisikan seluruh nama kelas \textit{filter} yang telah dibentuk. Kode \ref{kode:filtersnamebab4}

\begin{lstlisting}[caption=Penambahan nama \textit{filters} untuk didefinisikan menuju \textit{routes}, label=kode:filtersnamebab4]
	public array $aliases = [
        'csrf'          => CSRF::class,
        'toolbar'       => DebugToolbar::class,
        'honeypot'      => Honeypot::class,
        'invalidchars'  => InvalidChars::class,
        'secureheaders' => SecureHeaders::class,
        'check-installandlogin' => CheckInstallAndLogin::class,
        'check-login' => CheckLogin::class,
        'check-loginandlevelAdmin' => CheckLoginandLevelAdmin::class,
        'check-loginandlevelHead' => CheckLoginandLevelHead::class,
        'check-loginandcli' => CheckLoginandCLI::class,
        'check-loginandisajax' => CheckLoginandisAjax::class,
        'check-iscli' => CheckCLI::class,
     ]
\end{lstlisting}

Kode \ref{kode:filtersnamebab4} merupakan penambahan nama \textit{filters} untuk dipanggil menuju \textit{routes}. Penamaan ini akan ditambahkan pada \textit{array} \verb|$aliases| dengan \textit{index} dan nama kelasnya.
\subsubsection{\texttt{Routes.php}}
File ini akan berisikan seluruh pemindahan dan penambahan manual dari \textit{routes} pada \textit{SharIF Judge}. Kode \ref{kode:routesbab4} merupakan pembentukan \textit{routes} aplikasi secara manual.
\begin{lstlisting}[caption=Penambahan \textit{routes} yang digunakan pada aplikasi \textit{SharIF Judge}, label=kode:routesbab4]
	$routes->setDefaultNamespace('App\Controllers');
$routes->setDefaultController('Dashboard');
$routes->setDefaultMethod('index');
$routes->setTranslateURIDashes(false);
$routes->set404Override();
$routes->setAutoRoute(false);
// The Auto Routing (Legacy) is very dangerous. It is easy to create vulnerable apps
// where controller filters or CSRF protection are bypassed.
// If you don't want to define all routes, please use the Auto Routing (Improved).
// Set `$autoRoutesImproved` to true in `app/Config/Feature.php` and set the following to true.
// $routes->setAutoRoute(false);

/*
 * --------------------------------------------------------------------
 * Route Definitions
 * --------------------------------------------------------------------
 */

// We get a performance increase by specifying the defaul
// route since we don't have to scan directories.
$routes->get('/', 'Dashboard::index',['filter' => 'check-installandlogin:dual,noreturn']);
$routes->get('/dashboard', 'Dashboard::index',['filter' => 'check-installandlogin:dual,noreturn']);
$routes->post('/dashboard/widget_positions', 'Dashboard::widget_positions');
// Authentication
$routes->add('/install','Install::index');
$routes->add('/login','Login::index');
$routes->post('login/register','Login::register');
$routes->get('login/lost','Login::lost');
$routes->post('login/lost','Login::lost');
$routes->get('/reset/(:any)', 'Login::reset/$1');
$routes->post('login/reset/(:any)', 'Login::reset/$1');
$routes->get('/register','Login::register');
$routes->post('/register','Login::register');
$routes->get('/settings','Settings::index',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->post('/settings','Settings::index',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->add('/profile/(:num)','Profile::index/$1',['filter' => 'check-login:dual,noreturn']);
$routes->get('/logout','Login::logout');
$routes->add('/settings/update', 'Settings::update');
// Users
$routes->get('/profile', 'Profile::index');
$routes->get('/users', 'Users::index',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->get('/users/add', 'Users::add',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->post('/users/add', 'Users::add',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->post('/users/delete_submissions', 'Users::delete_submissions',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
$routes->get('users/list_excel', 'Users::list_excel',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
// Notifications and scoreboard
$routes->get('/notifications', 'Notifications::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('/notifications/add', 'Notifications::add',['filter' => 'check-login:dual,noreturn']);
$routes->post('/notifications/add', 'Notifications::add',['filter' => 'check-login:dual,noreturn']);
$routes->add('/notifications/edit/(:num)', 'Notifications::edit/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('/notifications/delete', 'Notifications::delete',['filter' => 'check-login:dual,noreturn']);
$routes->post('/notifications/check', 'Notifications::check',['filter' => 'check-login:dual,noreturn']);
$routes->get('/scoreboard','Scoreboard::index',['filter' => 'check-loginandcli:dual,noreturn']);
$routes->add('/server_time','Server_time::index',['filter' => 'check-loginandisajax:dual,noreturn']);
// Logs, hof, moss, rejudge, queue
$routes->get('logs', 'Logs::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('halloffame', 'Halloffame::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('moss/(:num)','Moss::index/$1',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('moss/(:num)','Moss::index/$1',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->get('moss/update/(:num)','Moss::update/$1',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('moss/update/(:num)','Moss::update/$1',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->get('queue','Queue::index',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('queue','Queue::index',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('queue/resume','Queue::resume',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('queue/pause','Queue::pause',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('queue/empty_queue','Queue::empty_queue',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->cli('queueprocess/run', 'Queueprocess::run');
$routes->get('rejudge', 'Rejudge::index',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('rejudge', 'Rejudge::index',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->get('rejudge/(:num)', 'Rejudge::index/$1',['filter' => 'check-loginandlevelHead:dual,noreturn']);
$routes->post('rejudge/rejudge_single','Rejudge::rejudge_single',['filter' => 'check-loginandlevelHead:dual,noreturn']);
//Assignments
$routes->get('/assignments','Assignments::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('/assignments/add','Assignments::add',['filter' => 'check-login:dual,noreturn']);
$routes->post('/assignments/add','Assignments::add',['filter' => 'check-login:dual,noreturn']);
$routes->post('/assignments/select','Assignments::select',['filter' => 'check-login:dual,noreturn']);
$routes->get('/assignments/edit/(:num)','Assignments::edit/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('/assignments/edit/(:num)','Assignments::edit/$1',['filter' => 'check-login:dual,noreturn']);
$routes->get('/assignments/delete/(:num)','Assignments::delete/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('/assignments/delete/(:num)','Assignments::delete/$1',['filter' => 'check-login:dual,noreturn']);
$routes->get('/assignments/pdf/(:num)/(:any)/(:any)','Assignments::pdf/$1/$2/$3',['filter' => 'check-login:dual,noreturn']);
$routes->get('/assignments/pdf/(:num)','Assignments::pdf/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('/assignments/pdfCheck/(:num)', 'Assignments::pdfCheck/$1');
$routes->get('/assignments/pdfCheck/(:num)', 'Assignments::pdfCheck/$1');
$routes->get('assignments/downloadtestsdesc/(:num)', 'Assignments::downloadtestsdesc/$1');
$routes->get('assignments/download_submissions/(:any)/(:num)', 'Assignments::download_submissions/$1/$2');
// Submit and submissions
$routes->get('submit','Submit::index',['filter' => 'check-login:dual,noreturn']);
$routes->post('submit','Submit::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('submit/load/(:num)','Submit::load/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('submit/save/(:any)','Submit::save/$1');
$routes->post('submit/save','Submit::save');
$routes->get('submit/get_output/(:num)','Submit::get_output/$1');
$routes->get('submissions/all/user/(:any)', 'Submissions::all');
$routes->get('submissions/final','Submissions::the_final',['filter' => 'check-login:dual,noreturn']);
$routes->get('submissions/final/(:any)','Submissions::the_final/$1',['filter' => 'check-login:dual,noreturn']);
$routes->post('/submissions/view_code', 'Submissions::view_code');
$routes->post('/submissions/select', 'Submissions::select');
$routes->get('/submissions/all_excel', 'Submissions::all_excel');
$routes->get('/submissions/final_excel', 'Submissions::final_excel');
$routes->get('submissions/download_file/(:any)/(:num)/(:num)/(:num)','Submissions::download_file/$1/$2/$3/$4');
$routes->get('submissions/all','Submissions::all');
// Problems
$routes->get('/problems', 'Problems::index',['filter' => 'check-login:dual,noreturn']);
$routes->get('/problems/(:num)','Problems::index/$1');
$routes->get('/problems/(:num)/(:num)','Problems::index/$1/$2');
$routes->get('/problems/edit/(:any)/(:num)/(:num)', 'Problems::edit/$1/$2/$3');
$routes->post('/problems/edit/(:any)/(:num)/(:num)', 'Problems::edit/$1/$2/$3');
\end{lstlisting}
Kode \ref{kode:routesbab4} merupakan seluruh \textit{routes} yang didefinisikan secara explisit sesuai dengan kegunaannya.

\subsubsection{\texttt{Secrets.php}}
File ini merupakan file yang dibentuk secara manual oleh pengguna. File ini berisikan seluruh kebutuhan konfigurasi yang tidak terdapat pada \textit{config} lainnya. Kode \ref{kode:secrets} merupakan pemindahan file \texttt{Secrets.php} menuju \texttt{app/Config}.
\begin{lstlisting}[caption=Penambahan file \textit{secrets}, label=kode:secrets]
namespace Config;

use CodeIgniter\Config\BaseConfig;
class Secrets extends BaseConfig
{ 
	public $shj_authenticate = 'radius';

public $shj_radius = [
    "server" => "localhost",
    "secret" => "i-have-no-secret"
];

// LDAP Settings reffers to
// @link https://adldap2.github.io/Adldap2/#/setup?id=options
public $shj_ldap = [
    "hosts" => ["dc3.ftis.unpar"],
    "base_dn" => "DC=FTIS,DC=UNPAR",
    "username"=> "",
    "password"=> "",
    "account_suffix"   => "@ftis.unpar"
];

public $shj_mail = [
    'protocol' => 'smtp',
    'SMTPHost' => 'ssl://smtp.mailgun.org',
    'SMTPPort' => 465,
    'SMTPUser' => '',
    'SMTPPass' => '',
    'mailType'  => 'html',
    'charset'   => 'utf-8'
];
}
\end{lstlisting}

Kode \ref{kode:secrets} merupakan pemindahan kode menuju \texttt{app/Config}. Terdapat penghapusan sintaks \texttt{defined('BASEPATH') OR exit('No direct script access allowed');} pada baris pertama kalimat. Sintaks yang telah dihapus akan digantikan oleh sintaks \textit{class} yang dapat dilihat pada baris pertama dan \textit{extend} \texttt{BaseConfig}. Terdapat juga penambahan sintaks \textit{namespace} dan \textit{use}. File ini akan digunakan dan dipanggil pada \textit{controller} untuk melakukan autentikasi pengguna.

\subsubsection{\texttt{Security.php}}
File ini akan berisikan seluruh konfigurasi yang dipindahkan dari \texttt{application/config/config.php}. Kode \ref{kode:security} merupakan pemindahan data menuju \texttt{Security.php}.
\begin{lstlisting}[caption=Pemindahan file \textit{config} menuju \textit{Security}, label=kode:security]
public string $tokenName = 'shj_csrf_token';
public string $cookieName = 'shjcsrftoken';
\end{lstlisting}

Kode \ref{kode:security} merupakan pemindahan sintaks menuju \texttt{Security.php}. Sintaks pada baris pertama merupakan nama \textit{token} yang akan digunakan sedangkan sintaks kedua merupakan nama \textit{cookie} yang akan digunakan. Sintaks pada \textit{CodeIgniter 4} tidak akan menggunakan \textit{array} namun akan disimpan menuju variabel. Sintaks lainnya tidak akan diubah karena akan menggunakan konfigurasi \textit{default} dari \textit{CodeIgniter 4}.

\subsubsection{\texttt{Session.php}}
File ini akan berisika seluruh konfigurasi yang dipindahkan dari \texttt{application/config/config.php}. Kode \ref{kode:session} merupakan pemindahan data menuju \texttt{Session.php}.
\begin{lstlisting}[caption=Pemindahan file \textit{config} menuju \textit{Session}, label=kode:session]
public string $driver = 'CodeIgniter\Session\Handlers\DatabaseHandler';
public string $cookieName = 'shjsession';
\end{lstlisting}

Kode \ref{kode:session} merupakan pemindahan data menuju \texttt{Session.php}. Data yang dipindahkan berupa \texttt{cookieName} yang akan disimpan menuju variabel. Selanjutnya akan ada perubahan \textit{driver} dimana akan menggunakan sintaks diatas karena akan disimpan menuju \textit{database}.

\subsubsection{\texttt{Validation.php}}
\label{subsubsec:validationbab4}
File ini berisikan aturan yang dapat dipakai untuk melakukan validasi sebelum diproses oleh aplikasi. Kode \ref{kode:validationrulesmanualbab4} merupakan aturan validasi data yang dibentuk secara manual oleh pengguna.

\begin{lstlisting}[caption=Perancangan aturan yang dibentuk secara manual pada file \texttt{Validation.php}, label=kode:validationrulesmanualbab4]
class MyRules
{   
    public function password_check($str): bool
    {
        if (strlen($str) == 0 OR (strlen($str) >= 6 && strlen($str) <= 200))
			return TRUE;
		return FALSE;
    }

    public function password_again_check($str) :bool
    {
        $request = \Config\Services::request();
        if ($request->getPost('password') !== $request->getPost('password_again'))
			return FALSE;
		return TRUE;
    }

    public function role_check($user,$role) 
    {
        $user = new User();
        if ($user->level <= 2)
			return ($role == '');

		// Admins can change everybody's user role:
		$roles = array('admin', 'head_instructor', 'instructor', 'student');
		return in_array($role, $roles);
    }

    /**
	 * Checks whether a user with this email exists
	 */
	public function email_check($email,$edit_username):bool
	{
        $user_model = new UserModel();
		if ($user_model->have_email($email, $edit_username))
			return FALSE;
		return TRUE;
	}

    /**
	 * checks whether the entered registration code is correct or not
	 *
	 */
	public function _registration_code($code){
        $settings_model = new SettingsModel();
		$rc = $settings_model->get_setting('registration_code');
		if ($rc == '0')
			return TRUE;
		if ($rc == $code)
			return TRUE;
		return FALSE;
	}

    /**
	 * Required
	 *
	 * @param	string
	 * @return	bool
	 */
	public function required($str)
	{
		return is_array($str) ? (bool) count($str) : ($str !== '');
	}


	// -------------------------------------------------------------------------


	/**
	 * Is Lowercase
	 *
	 * @param $str
	 * @return bool
	 */
	public function lowercase($str)
	{
		return (strtolower($str) === $str);
	}

    	// ------------------------------------------------------------------------


	public function _check_language($str)
	{
		if ($str=='0')
			return FALSE;
		if (in_array( strtolower($str),array('c', 'c++', 'python 2', 'python 3', 'java', 'zip', 'pdf', 'txt')))
			return TRUE;
		return FALSE;
	}


	// ------------------------------------------------------------------------
	// Used in Submissions.php

	public function _check_type($type)
	{
		return ($type === 'code' || $type === 'result' || $type === 'log');
	}
}
\end{lstlisting}

Kode \ref{kode:validationrulesmanualbab4} merupakan pembentukan aturan secara manual yang dipindahkan dari \textit{controller} \texttt{Login.php}, \texttt{Profile.php}, \texttt{Submissions.php}, dan \texttt{Submit.php}. Aturan yang dibentuk secara manual dapat digunakan seperti aturan lainnya yang tersedia pada \textit{CodeIgniter 4}.

\subsection{\textit{Controllers}}
\textit{Controller} terdapat perubahan pada bagian fungsi \texttt{\_\_construct()} dimana sekarang tidak dapat mengembalikan sesuatu. Oleh karena itu, akan dibentuk beberapa \textit{filters} \ref{subsubsec:filters} untuk melakukan pengecekan terhadap fungsi yang sebelumnya terdapat pada \texttt{\_\_construct()}.
	\subsubsection{app/Controllers} 
	Direktori ini berisikan seluruh \textit{controller} yang dipindahkan dari \textit{CodeIgniter 3}. Berikut merupakan isi pada direktori ini:
	\begin{itemize}
		\item \texttt{Assignments.php}
		\item \texttt{BaseController.php}
		\item \texttt{Dashboard.php}
		\item \texttt{Halloffame.php}
		\item \texttt{Install.php}
		\item \texttt{Login.php}
		\item \texttt{Logs.php}
		\item \texttt{Moss.php}
		\item \texttt{Notifications.php}
		\item \texttt{Problems.php}
		\item \texttt{Profile.php}
		\item \texttt{Queue.php}
		\item \texttt{Queueprocess.php}
		\item \texttt{Rejudge.php}
		\item \texttt{Scoreboard.php}
		\item \texttt{Server\_time.php}
		\item \texttt{Settings.php}
		\item \texttt{Submissions.php}
		\item \texttt{Submit.php}
		\item \texttt{Users.php}
	\end{itemize}

\textit{Controllers} terdapat perubahan dan penambahan baik dalam \textit{extends} maupun dalam pemanggilan kelas lain seperti \textit{model}. Kode \ref{kode:controllerBab4} merupakan perubahan yang terdapat pada \textit{controller} \texttt{Logs.php}.

\begin{lstlisting}[caption=Perubahan kode \textit{controllers} pada \textit{CodeIgniter 4}, label=kode:controllerBab4]
namespace App\Controllers;

use App\Controllers\BaseController;
use App\Models\AssignmentModel;
use App\Models\LogsModel;
use App\Models\User;

class Logs extends BaseController
{
	protected $session;
	protected $user;
	protected $logs_model;
	protected $assignment_model;

	public function __construct()
	{
		$this->session = session();
		$this->logs_model = new LogsModel();
		$this->assignment_model = new AssignmentModel();
		$this->user = new User();
		if ( $this->user->level <= 2) // permission denied
			throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound();
	}
	
	public function index()
	{

		$data = array(
			'logs' => $this->logs_model->get_all_logs(),
			'selected' => 'logs',
			'user' => $this->user,
			'all_assignments' => $this->assignment_model->all_assignments(),
			'finish_time' => $this->user->selected_assignment['finish_time'],
			'extra_time' => $this->user->selected_assignment['extra_time'],
		);

		return view('pages/admin/logs', $data);
	}
}
\end{lstlisting}

Kode \ref{kode:controllerBab4} terdapat perubahan dimana sekarang akan \textit{extends} \textit{BaseController}. Terdapat juga penghapusan sintaks \texttt{defined('BASEPATH') OR exit('No direct script access allowed');}. Terdapat penambahan sintaks \textit{namespace} dan juga beberapa sintaks untuk memanggil \textit{models}. \textit{Controller} juga memiliki perubahan dalam mengembalikan \textit{view} dimana sekarang menggunakan sintaks \texttt{return view}. Selain itu terdapat penambahan pada \texttt{BaseController.php} untuk melakukan inisiasi terhadap \textit{helpers} dan juga beberapa \textit{library} yang akan digunakan. Kode \ref{kode:basecontrollerhelpers} merupakan penambahan \textit{helpers} yang dapat diakses oleh seluruh \textit{controller}

\begin{lstlisting}[caption=Penambahan kode pada \texttt{BaseController}, label=kode:basecontrollerhelpers]
	protected $helpers = ['text','url','shj_helper','form','cookie','string','filesystem'];
\end{lstlisting}

Kode \ref{kode:basecontrollerhelpers} merupakan pemindahan dan penambahan \textit{helpers} dari \textit{autoload}. Seluruh \textit{helpers} yang telah dipindahkan diakses pada seluruh \textit{controller}. Penambahan ini dilakukan untuk mempermudah dalam penggunaan 

\subsection{\textit{Filters}}
Pada \textit{CodeIgniter 4} \texttt{\_\_construct()} tidak dapat mengembalikan sesuatu oleh karena itu akan dibentuk beberapa \textit{filters} untuk melakukan pengecekan. Beberapa \textit{filters} yang dibentuk antara lain berfungsi untuk mengecek apakah dijalankan dari \textit{command line interface}, apakah sudah \textit{install} dan \textit{login}, apakah sudah \textit{login}, apakah sudah \textit{login} dan dijalankan dari \textit{command line interface}, apakah sudah \textit{login} dan apakah \textit{request} berupa \textit{AJAX}, dan apakah sudah \textit{login} dan pengecekan terhadap \textit{role} pengguna. Terdapat total empat buah \textit{filters} yang akan dibentuk. Kode \ref{kode:filtersclibab4} merupakan sintaks untuk melakukan pengecekan apakah dijalankan dari \textit{command line interface}.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters} \texttt{CheckCLI.php}, label=kode:filtersclibab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $request = \Config\Services::request();

        if ($request->isCLI())
            throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound();
    }
\end{lstlisting}
Kode \ref{kode:filtersclibab4} merupakan pemindahan kode dari \texttt{\_\_construct} menuju \textit{filters} \texttt{CheckCLI}.  \texttt{\_\_construct} terdapat pada \textit{controller} dimana fungsi diatas digunakan pada \textit{controller} \texttt{Queueprocessphp}. Kode ini akan mengecek apakah \textit{request} yang diberikan oleh pengguna merupakan \textit{command line interface}. Apabila \textit{request} yang diberikan bukan berupa itu maka akan diberikan error berupa halaman tidak ditemukan. Kode \ref{kode:filtersinstallandloginbab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna sudah melakukan \textit{install} dan \textit{login}.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersinstallandloginbab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $db = Database::connect();

        if ( !$db->tableExists('sessions'))
			return redirect()->to('/install');
        
        $session = \Config\Services::session();
		if ( !$session->get('logged_in')) // if not logged in
			return redirect()->to('/login');
    }
\end{lstlisting}

Kode \ref{kode:filtersinstallandloginbab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller} \texttt{Dashboard}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai apabila tidak sesuai dengan kondisinya. Kode \ref{kode:filtersloginbab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna sudah melakukan \textit{login}.
\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersloginbab4]
	public function before(RequestInterface $request, $arguments = null)
    {
        $session = \Config\Services::session();

        if ( !$session->get('logged_in')) // if not logged in
			return redirect()->to('login');
    }
\end{lstlisting}

Kode \ref{kode:filtersloginbab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller} \texttt{Profile}, \texttt{Notifications}, \texttt{Logs}, \texttt{Assignments}, \texttt{Submit}, \texttt{Submission}, dan \texttt{Problems}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai. Kode \ref{kode:filtersloginandclibab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna menjalankan \textit{request} dari \textit{command line interface} dan apakah pengguna sudah melakukan \textit{login}.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersloginandclibab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $session = \Config\Services::session();
        $request = \Config\Services::request();

        if ($request->isCLI())
            return;
        if ( !$session->get('logged_in')) // if not logged in
            return redirect()->to('login');
    }
\end{lstlisting}

Kode \ref{kode:filtersloginandclibab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller}  \texttt{Scoreboard}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai apabila tidak sesuai dengan kondisinya. Kode \ref{kode:filtersloginnadisajaxbab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna sudah melakukan login dan apakah \textit{request} yang diberikan pengguna berupa \textit{ajax}.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersloginnadisajaxbab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $session = \Config\Services::session();
        $request = \Config\Services::request();

		if ( !$session->get('logged_in')) // if not logged in
			return redirect()->to('/login');
        if ( !$request->isAJAX() )
			throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound();
    }
\end{lstlisting}

Kode \ref{kode:filtersloginnadisajaxbab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller}  \texttt{Server\_time}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai apabila tidak sesuai dengan kondisinya. Kode \ref{kode:filtersloginandleveladminbab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna sudah melakukan login dan apakah \textit{role} dari pengguna dapat mengakses situs tersebut.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersloginandleveladminbab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $session = \Config\Services::session();
        $user = new User();

		if ( !$session->get('logged_in')) // if not logged in
			return redirect()->to('/login');
        if ( $user->level <= 2) // permission denied
			throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound();	
    }
\end{lstlisting}

Kode \ref{kode:filtersloginandleveladminbab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller}  \texttt{Server\_time}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai apabila tidak sesuai dengan kondisinya. Kode \ref{kode:filtersloginandlevelheadbab4} merupakan \textit{filters} yang dibentuk untuk melakukan pengecekan apakah pengguna sudah melakukan login dan apakah \textit{role} dari pengguna dapat mengakses situs tersebut.

\begin{lstlisting}[caption=Pemindahan kode pada \textit{Filters}, label=kode:filtersloginandlevelheadbab4]
	public function before(RequestInterface $request, $arguments = null)
    {   
        $session = \Config\Services::session();
        $user = new User();

		if ( !$session->get('logged_in')) // if not logged in
			return redirect()->to('/login');
        if ( $user->level <= 1) // permission denied
			throw \CodeIgniter\Exceptions\PageNotFoundException::forPageNotFound();	
    }
\end{lstlisting}

Kode \ref{kode:filtersloginandleveladminbab4} merupakan pemindahan dari \texttt{\_\_construct} pada \textit{controller}  \texttt{Server\_time}. Fungsi pada \textit{filters} ini akan melakukan pengecekan dan mengembalikan pengguna kepada \textit{routes} yang sesuai apabila tidak sesuai dengan kondisinya. Setelah dibentuk \textit{filters}, selanjutnya akan ditambahkan menuju file \texttt{Filters.php} untuk mendefiniskan nama yang selanjutnya akan dimasukkan menuju \textit{routes}. Penambahan menuju file \texttt{Filters.php} dapat dilihat pada subbab \ref{subsubsec:filters}. Setelah ditambahkan, \textit{filters} akan dipanggil pada \textit{routes} yang membutuhkan pengecekan. Kode \ref{kode:filtersroutesbab4} merupakan penambahan \textit{filters} pada \textit{routes} sesuai dengan kebutuhannya.

\begin{lstlisting}[caption=Penambahan \textit{filter} pada \textit{routes}, label=kode:filtersroutesbab4]
	$routes->get('/settings','Settings::index',['filter' => 'check-loginandlevelAdmin:dual,noreturn']);
\end{lstlisting}

Kode \ref{kode:filtersroutesbab4} menambahkan \textit{filter} yang sudah dibentuk dan dinamakan setelah penulisan nama \textit{controller} dan fungsinya. 

\subsection{\textit{Helpers}}
Direktori ini berisikan \textit{helpers} yang dibentuk secara manual oleh pengguna bernama \texttt{shj\_helper}. \textit{Helpers} terdapat perubahan dan penghapusan sintaks. Sintaks \texttt{defined('BASEPATH') OR exit('No direct script access allowed');} akan dihapus dan akan ditambahkan beberapa \textit{model} yang digunakan pada \textit{helper} ini. \textit{Model} yang ditambahkan berupa \texttt{settings\_model}.

\subsection{\textit{Libraries}}
\textit{Libraries} terdapat beberapa perubahan dan penghapusan fungsi sehingga akan digantikan. Berikut merupakan perancangan perubahan fungsi pada \textit{CodeIgniter 4}.

\subsubsection{\textit{Emails}}
\textit{Emails} pada \textit{CodeIgnier 4} terdapat perubahan sintaks dan cara pemanggilan sehingga akan dipindahkan sesuai dengan sintaks yang baru. Sintaks berubah dari yang sebelumnya menggunakan \textit{snakecase} menjadi menggunakan \textit{camelcase}. Kode \ref{kode:emailslibbab3} merupakan contoh penggunaan \textit{library email}.

\begin{lstlisting}[caption=Perubahan penggunaan sintaks pada \textit{library emails}, label=kode:emailslibbab3]
$this->email->setFrom($this->settings_model->get_setting('mail_from'), $this->settings_model->get_setting('mail_from_name'));
				$this->email->setTo($user[1]);
				$this->email->setSubject('SharIF Judge Username and Password');
				$text = $this->settings_model->get_setting('add_user_mail');
				$text = str_replace('{SITE_URL}', base_url(), $text);
				$text = str_replace('{ROLE}', $user[4], $text);
				$text = str_replace('{USERNAME}', $user[0], $text);
				$text = str_replace('{PASSWORD}', htmlspecialchars($user[3]), $text);
				$text = str_replace('{LOGIN_URL}', base_url(), $text);
				$this->email->setMessage($text);
				$this->email->send()
\end{lstlisting}

Kode \ref{kode:emailslibbab3} memiliki sintaks dengan nama sama namun terdapat perubahan menjadi \textit{camelcase}.

\subsubsection{\textit{Working with Uploaded Files}}
\textit{Working with uploaded files} terdapat perubahan pada beberapa sintaks dan validasi terhadap \textit{file} yang telah diunggah. Konversi aplikasi \textit{SharIF Judge} akan menggunakan fungsi ini dengan beberapa perubahan sintaks sesuai dengan dokumentasinya. Kode \ref{kode:uploadfilebab4} merupakan perubahan yang terdapat pada \textit{library} ini. 
\begin{lstlisting}[caption=Perancangan perubahan \textit{library upload} pada \textit{CodeIgniter 4}, label=kode:uploadfilebab4]
$zip_uploaded = $this->request->getFile('tests_desc');
		if ( $_FILES['tests_desc']['error'] === UPLOAD_ERR_NO_FILE ){
			$this->messages[] = array(
				'type' => 'notice',
				'text' => "Notice: You did not upload any zip file for tests. If needed, upload by editing assignment."
			);
		}
		elseif ( $zip_uploaded->getExtension() != "zip"){
			$this->messages[] = array(
				'type' => 'error',
				'text' => "Error: Error uploading tests zip file: The filetype you are attempting to upload is not allowed."
			);
		}
		else{
			$zip_uploaded->move($assignments_root);
			$this->messages[] = array(
				'type' => 'success',
				'text' => "Tests (zip file) uploaded successfully."
			);
		}
\end{lstlisting}

Kode \ref{kode:uploadfilebab4} merupakan perubahan yang terdapat pada \textit{library upload}. Pengambilan file akan digantikan dengan sintaks \verb|$this->request->getFile('')| dengan parameter berupa nama dari \textit{tag form} yang sudah dibentuk. Selanjutnya akan dilakukan pengecekan terhadap file yang sudah di unggah dan memberikan beberapa \textit{error message} sesuai dengan kondisinya. File yang sudah di unggah akan dipindahkan menuju direktori \texttt{assignments\_root}. 

\subsubsection{Request}
\textit{Input} akan digantikan oleh fungsi \textit{request} dengan perubahan cara pemanggilan sintaks. \textit{Validation} hanya akan diinisiasikan pada fungsi \texttt{\_\_construct} setiap \textit{model} yang membutuhkan. Kode \ref{kode:requestbab4} merupakan inisiasi \textit{request} pada \textit{model}.

\begin{lstlisting}[caption=Perancangan inisiasi \textit{request} pada \texttt{\_\_construct}, label=kode:requestbab4]

protected $request;

	public function __construct()
	{
		$this->request = \Config\Services::request(); 
	}
\end{lstlisting}

Kode \ref{kode:requestbab4} merupakan inisiasi yang dilakukan pada \textit{model}. \textit{Controller} tidak perlu melakukan inisiasi terhadap fungsi ini karena sudah terinisiasi pada \texttt{BaseController}. Pengambilan \textit{input} yang dilakukan oleh pengguna dilakukan menggunakan sintaks pada kode \ref{kode:requestbab4howto}.

\begin{lstlisting}[caption=Perancangan penggunaan \textit{request}, label=kode:requestbab4howto]
if($this->request->isAJAX())
$this->request->getPost('assignment_select')
\end{lstlisting}

Kode \ref{kode:requestbab4howto} merupakan cara penggunaan \textit{request} untuk melakukan pengecekan dan pengambilan data. Sintaks berubah dari yang sebelumnya menggunakan \textit{snakecase} menjadi \textit{camelCase}.

\subsubsection{\textit{Validation}}
\textit{Form\_validation} akan digantikan oleh fungsi \textit{validation} dengan perubahan dan pengapusan beberapa fungsi. \textit{Validation} akan diinisiasikan pada fungsi \texttt{\_\_construct} pada setiap \textit{controller} yang membutuhkan. Kode \ref{kode:validationinitiationbab4} merupakan inisiasi \textit{validation} pada \textit{controller}.

\begin{lstlisting}[caption=Perancangan inisiasi \textit{validation} pada \texttt{\_\_construct}, label=kode:validationinitiationbab4]

protected $validation;

	public function __construct()
	{
		$this->validation = \Config\Services::validation();
	}
\end{lstlisting}

Kode \ref{kode:validationinitiationbab4} merupakan sintaks untuk melakukan inisiasi terhadap \textit{validation}. Setiap \textit{controller} yang menggunakan \textit{validation} akan dideklarasikan sebuah variabel bernama \textit{validation} agar dapat dipanggil pada seluruh fungsi yang membutuhkan pada kelas tersebut. \textit{Validation} dilanjutkan dengan penetapan aturan untuk \textit{tag form} yang diinginkan. Berikut merupakan contoh pembentukan aturan untuk mengumpulkan sebuah data pada \textit{form}.

\begin{lstlisting}[caption=Perancangan perubahan konfigurasi aturan pada \textit{library validation}, label=kode:validationrulesbab4]
$this->validation->setRule('username', 'username', 'required|min\_length[3]|max\_length[20]);
\end{lstlisting}

Kode \ref{kode:validationrulesbab4} akan menetapkan aturan terhadap \textit{input} yang akan masukan oleh pengguna sesuai dengan nama \textit{form}nya. Sedangkan penetapan aturan berubah menggunakan \textit{camelCase}. Aturan yang dibentuk secara manual akan dipindahkan menuju file \texttt{Validation.php}. Pembentukan aturan dapat dilihat pada sub bab \ref{subsubsec:validationbab4} kode \ref{kode:validationrulesmanualbab4}. Aturan yang sudah dibentuk dapat digunakan seperti aturan lainnya dengan cara menulis nama kelasnya. Setelah aturan ditetapkan akan dieksekusi berdasarkan \textit{request} dari pengguna dan dilakukan validasi. Kode \ref{kode:validationrunbab4} merupakan perubahan penggunaan \textit{validation} terhadap data yang sudah diberikan oleh pengguna.
\begin{lstlisting}[caption=Perancangan perubahan penggunaan \textit{validation} pada \textit{CodeIgniter 4}, label=kode:validationrunbab4]
if ($this->validation->withRequest($this->request)->run())
		{
			if ( !$this->request->isAJAX() ){
				exit;
			}else{
				list($ok, $error) = $this->user_model->add_users(
					$this->request->getPost('new_users'),
					$this->request->getPost('send_mail'),
					$this->request->getPost('delay')
				);
			return view('pages/admin/add_user_result', array('ok' => $ok, 'error' => $error));
			}
		}
\end{lstlisting}

Kode \ref{kode:validationrunbab4} akan menjalankan \textit{validation} berdasarkan \textit{request} dari pengguna. \textit{Validation} akan tetap menggunakan sintaks \texttt{run()} namun akan ada penambahan sintaks \texttt{withRequest} dimana validasi akan dijalankan setiap ada \textit{HTTP Request} dari pengguna. Namun, \textit{CodeIgniter 4} tidak menyediakan fungsi \texttt{form\_error} sehingga akan diubah dengan menggunakan fungsi baru bernama \texttt{validation\_errors()}. Fungsi tersebut dapat digunakan untuk mengembalikan \textit{error} apabila terdapat data yang tidak sesuai dengan aturan. \textit{Error} tersebut dapat ditampilkan pada halaman \textit{view} menggunakan sintaks berikut.

\begin{center}
\verb|<?= $validation->hasError('username') ? $validation->getError('username') : '' ?>|
\end{center}

Sintaks diatas akan melakukan pengecekan apakah terdapat \textit{error} dari \textit{form} bernama \texttt{username} dan apabila terdapat maka akan dikembalikan dara \textit{error} yang berasal dari \textit{validation}. Variabel \texttt{validation} akan dikirimkan dari \textit{controller} berisikan \textit{library validation}.

\subsubsection{\textit{Zip Archive}}
\textit{Zip Encoding} akan digantikan dengan fungsi PHP \textit{zip archive} karena sudah tidak tersedia pada \textit{CodeIgniter 4}. Fungsi \textit{zip archive} terdapat beberapa perbedaan sehingga akan disesuaikan dengan fungsi-fungsi yang ada. Kode \ref{kode:ziparchivebab4} merupakan perubahan yang terdapat pada \textit{zip encoding}.

\begin{lstlisting}[caption=Perancangan perubahan \textit{zip encoding} menjadi \textit{zip archive}, label=kode:ziparchivebab4]
$this->zip = new \ZipArchive();
		$this->zip->open($zipname, ZipArchive::CREATE);
		for ($i=1 ; $i<=$number_of_problems ; $i++)
		{

			$path = "$root_path/p{$i}/in";
			$options = ['add_path' => "p{$i}/in/", 'remove_all_path' => TRUE];
			$this->zip->addGlob($path.'/*.{txt}', GLOB_BRACE, $options);

			$path = "$root_path/p{$i}/out";
			$options = ['add_path' => "p{$i}/out/", 'remove_all_path' => TRUE];
			$this->zip->addGlob($path.'/*.{txt}', GLOB_BRACE, $options);

			$path = "$root_path/p{$i}/tester.cpp";
			if (file_exists($path))
				$this->zip->addFile($path,"p{$i}/tester.cpp");

			$pdf_files = glob("$root_path/p{$i}/*.pdf");
			if ($pdf_files)
			{
				$path = $pdf_files[0];
				$this->zip->addFile($path,"p{$i}/".shj_basename($path));
			}

			$path = "$root_path/p{$i}/desc.html";
			if (file_exists($path))
				$this->zip->addFile($path,"p{$i}/desc.html");

			$path = "$root_path/p{$i}/desc.md";
			if (file_exists($path))
				$this->zip->addFile($path,"p{$i}/desc.md");
		}

		$pdf_files = glob("$root_path/*.pdf");
		if ($pdf_files)
		{
			$path = $pdf_files[0];
			$this->zip->addFile($path,shj_basename($path));
		}
		$this->zip->close();
		
		header('Content-Type: application/zip');
		header('Content-disposition: attachment; filename=' . $zipname);
		header('Content-Length: ' . filesize($zipname));
		readfile($zipname);
\end{lstlisting}

Kode \ref{kode:ziparchivebab4} merupakan perubahan dari \textit{zip encoding} menjadi \textit{zip archive}. \textit{Zip archive} akan dilakukan inisiasi pada variabel \texttt{zip}. Selanjutnya akan dibuka file \textit{zip} menggunakan sintaks \texttt{open} yang menerima dua buah parameter. Parameter pertama berisikan nama \textit{zip} file yang ingin dibentuk sedangkan parameter kedua berisikan mode \textit{zip} yang diinginkan. Sintaks \texttt{addGlob} akan memasukan seluruh file sesuai dengan pattern yang telah ditentukan. Sintaks \texttt{addFile} akan memasukan file sesuai dengan \textit{path} yang telah ditentukan. Selanjutnya \textit{zip} akan ditutup menggunakan sintaks \texttt{close} dan dapat diunduh oleh pengguna menggunakan fungsi \textit{header} yang disediakan oleh PHP.


Selain untuk membentuk file \textit{zip}, \textit{zip archive} juga mendukung fungsi untuk melakukan \textit{unzip} sehingga akan menggantikan \textit{library unzip} yang sebelumnya dibentuk oleh Phil Sturgeon. Kode \ref{kode:unzipcontroller} merupakan penggunaan \textit{zip archive} untuk \textit{unzip} sebuah file pada \textit{controller}.

\begin{lstlisting}[caption=Perancangan perubahan \textit{unzip} menggunakan \textit{zip archive} pada \textit{controller}, label=kode:unzipcontroller]
$this->unzip = new ZipArchive();
			// Create a temp directory
			$tmp_dir_name = "shj_tmp_directory";
			$tmp_dir = "$assignments_root/$tmp_dir_name";

			// Extract new test cases and descriptions in temp directory
			$this->unzip->open("$assignments_root/".$zip_uploaded->getName());
			$extract_result = $this->unzip->extractTo($tmp_dir);
			$this->messages[] = array(
					'type' => 'error',
					'text' => " Zip Extraction Error: ".$this->unzip->getStatusString(),
				);
\end{lstlisting}

Kode \ref{kode:unzipcontroller} merupakan perubahan melakukan \textit{unzip} menggunakan \textit{zip archive}. Sintaks pada baris pertama akan melakukan inisiasi terhadap \textit{zip archive} sedangkan baris kedua dan ketiga akan membentuk variabel dengan nama direktori yang dituju. Sintaks \texttt{open} akan membuka sebuah file \textit{zip} sesuai dengan nama \textit{zip} tersebut. Sintaks selanjutnya akan melakukan \textit{extract} file \textit{zip} tersebut menuju direktori yang telah dibentuk dan menyimpannya pada sebuah variabel. Selanjutnya pengguna dapat mengambil status dari hasil \textit{extract} yang telah dilakukan. 

\subsubsection{\textit{Password\_hash}}
\textit{Library} ini tidak akan digunakan dan akan digantikan oleh \textit{password hash} yang disediakan oleh PHP .\textit{Library} \textit{Password\_hash} merekomendasikan pegguna untuk menggunakan fungsi \textit{native} yang disediakan oleh PHP apabila aplikasi mendukung PHP versi 5.5 ke atas. Sehingga, akan dilakukan konversi menggunakan fungsi yang disediakan oleh PHP bernama \texttt{password\_hash()}. Seluruh penggunaan \textit{library} ini akan diubah menggunakan fungsi yang disediakan oleh PHP dengan metode \textit{hashing} sama yaitu \textit{CRYPT\_BLOWFISH}. Perubahan fungsi \textit{hashing} ini bersifat \textit{backward compatible} sehingga dapat menggunakan \textit{database} aplikasi terdahulu tanpa perlu membentuk data baru. Berikut merupakan contoh pengubahan kode dari \textit{phpass} menjadi \textit{password\_hash}.

\begin{center}
\verb|'password' => $this->password_hash->HashPassword($password)|
\end{center}
menjadi
\begin{center}
\verb|'password' => password_hash($password,PASSWORD_BCRYPT)|
\end{center}

Sintaks \texttt{password\_hash()} diatas menerima dua buah parameter yakni data yang ingin di enkripsi dan tipe enkripsi. Enkripsi akan menggunakan sintaks \texttt{PASSWORD\_BCRYPT} yang menggunakan tipe \textit{hash} berupa \texttt{CRYPT\_BLOWFISH}. Selain itu, terdapat fungsi untuk melakukan pengecekan \textit{password} yang sudah di enkripsi. Berikut merupakan contoh pengubahan kode untuk melakukan pengecekan \textit{password} yang sudah di enkripsi.
\begin{center}
\verb|password_verify($password, $query->getRow()->password)|
\end{center}
Sintaks diatas menerima dua buah parameter dengan parameter pertama berupa masukan dari pengguna dan parameter berikutnya merupakan \textit{hash} dari \textit{password} yang sudah disimpan. Fungsi ini akan mengembalikan data berupa \textit{true} apabila \textit{password} sama dan \textit{false} apabila \textit{password} berbeda.

\textit{Library} yang terdapat pada \textit{CodeIgniter 4} juga dapat di\textit{extend} dan dibentuk sesuai dengan kebutuhan. Berikut merupakan \textit{library} yang dibentuk oleh pengguna dan akan dipindahkan menuju \texttt{app/Libraries}.

\subsubsection{\textit{Twig}}
\textit{Library} ini tidak akan digunakan untuk membentuk \textit{view} pada \textit{CodeIgniter 4} namun, akan ada penggunaan sebuah fungsi \textit{Twig} yang akan dibentuk pada direktori \texttt{app/Libraries}. Fungsi tersebut bernama \texttt{extra\_time\_formatter} yang memiliki fungsi untuk mengubah input yang diberikan menjadi format jam dikali enam puluh menit. Kode \ref{kode:twigextratime} merupakan fungsi yang akan dibentuk pada direktori \texttt{app/Libraries} dengan nama \texttt{Twig.php}.
\begin{lstlisting}[caption=Perancangan perubahan \textit{library MY\_Form\_validation} pada \textit{CodeIgniter 4}, label=kode:twigextratime]
<?php
namespace App\Libraries;

class Twig
{

	/**
	 * Required
	 *
	 * @param	string
	 * @return	bool
	 */
	public function extra_time_formatter($extra_time)
	{
		// convert to minutes
		$extra_time = floor($extra_time/60);
		// convert to H*60
		if ($extra_time % 60 == 0 )
			$extra_time = ($extra_time/60) . '*60';
		return $extra_time;
	}
}

\end{lstlisting}

Kode \ref{kode:twigextratime} merupakan fungsi yang akan dibentuk pada file \texttt{Twig.php}. Fungsi ini akan dipanggil pada halaman \texttt{add\_assignment.php}.

\subsubsection{\textit{MY\_Form\_validation}}
\textit{Library MY\_Form\_validation} akan dipindahkan menuju direktori \texttt{app/Libraries}. \textit{Library} ini akan digunakan kembali dengan perubahan \textit{extends} menjadi menuju \texttt{Validation}, penghapusan sintaks \texttt{defined} , dan akan ada penambahan \textit{namespace} pada baris awal file. Kode \ref{kode:myformvalidationbab3} merupakan contoh penambahan \textit{namespace} dan penggantian \textit{extends} pada \textit{library} ini.
\begin{lstlisting}[caption=Contoh perubahan \textit{library MY\_Form\_validation} pada \textit{CodeIgniter 4}, label=kode:myformvalidationbab4]
namespace App\Libraries;

use CodeIgniter\Validation\Validation;

class MY_Form_validation extends Validation
\end{lstlisting}
Kode \ref{kode:myformvalidationbab4} mengapus sintaks \texttt{defined} dan menggantikannya dengan penambahan \textit{namespace}. Selain itu, kelas \textit{library} akan \textit{extends} \textit{Validation}.

\subsubsection{\textit{Parsedown}}
\textit{Library Parsedown} akan dipindahkan menuju direktori \texttt{app/Libraries}. \textit{Library} ini akan digunakan kembali dengan penambahan \textit{namespace} pada baris awal file dan penghapusan sintaks \texttt{defined}.  Kode \ref{kode:parsedownbab3} merupakan contoh penambahan \textit{namespace} dan juga penambahan sintaks \textit{defined}.
\begin{lstlisting}[caption=Perancangan perubahan \textit{library Parsedown} pada \textit{CodeIgniter 4}, label=kode:parsedownbab3]
namespace App\Libraries;

class Parsedown
\end{lstlisting}
Kode \ref{kode:parsedownbab3} menghapus sintaks \texttt{defined} dan menggantikannya dengan penambahan \textit{namespace}. Penggunaan \textit{library} ini tidak akan berubah sehingga tidak terdapat perbedaan sintaks. Namun, terdapat perubahan cara inisiasi \textit{library} ini dimana sekarang akan menggunakan sintaks \textit{new} dan dilakukan inisiasi pada \textit{BaseController}. Kode \ref{kode:parsedownbab3initiate} merupakan perubahan cara melakukan inisiasi \textit{library parsedown}.

\begin{lstlisting}[caption=Perancangan perubahan inisiasi \textit{library Parsedown} pada \textit{controller CodeIgniter 4}, label=kode:parsedownbab3initiate]
 	protected $parsedown;

    /**
     * Constructor.
     */
    public function initController(RequestInterface $request, ResponseInterface $response, LoggerInterface $logger)
    {
        // Do Not Edit This Line
        parent::initController($request, $response, $logger);

        // Preload any models, libraries, etc, here.

        // E.g.: $this->session = \Config\Services::session();
        $this->parsedown = new Parsedown();
    }
\end{lstlisting}

Kode \ref{kode:parsedownbab3initiate} merupakan perubahan inisiasi pada \textit{CodeIgniter 4}. \textit{Library parsedown} akan dilakukan inisiasi menuju variabel \texttt{parsedown} yang sudah dibentuk pada luar fungsi. Inisiasi dilakukan pada \textit{BaseController} karena terdapat pemakaian pada beberapa \textit{model} dan \textit{controller}. 

\subsubsection{\textit{Phpexcel}}
\textit{Library} ini akan digunakan kembali namun tidak akan dipindahkan menuju \texttt{app/Libraries}. \textit{Library} akan dilakukan instalasi melalui \textit{composer} dengan sintaks berikut:
\begin{center}
	\verb|composer require phpoffice/phpexcel|
\end{center}
Sintaks diatas akan dijalankan pada akar dari aplikasi dan tidak terdapat perubahan terhadap penggunaan sintaks ini.

\subsubsection{\textit{Shj\_pagination}}
\textit{Library} ini akan digunakan kembali dan dipindahkan menuju direktori \texttt{app/Libraries}. Selain itu, terdapat penambahan \textit{namespace} pada baris awal file dan penghapusan sintaks \textit{defined}. Kode \ref{kode:shjpaginationbab4} merupakan penambahan perubahan dan penambahan sintaks pada \textit{library} ini.

\begin{lstlisting}[caption=Perancangan perubahan \textit{library Shj\_pagination} pada \textit{CodeIgniter 4}, label=kode:shjpaginationbab4]
namespace App\Libraries;

class Shj_pagination
{
\end{lstlisting}

Kode \ref{kode:shjpaginationbab4} merupakan perubahan sintaks dalam membentuk \textit{library} ini. Selanjutnya \textit{library} dapat dipanggil menggunakan sintaks berikut.

\begin{center}
\verb|$shj_pagination = new Shj_pagination($config);|
\end{center}

Sintaks diatas akan memanggil \textit{library} dan memasukan konfigurasi yang telah dibentuk.

\subsection{\textit{Models}}
Direktori ini akan berisikan seluruh \textit{model} yang dipindahkan dari \textit{CodeIgniter 3}. Berikut merupakan isi pada direktori ini:
\begin{itemize}
	\item \texttt{AssignmentModel.php}
	\item \texttt{HofModel.php}
	\item \texttt{LogsModel.php}
	\item \texttt{NotificationsModel.php}
	\item \texttt{QueueModel.php}
	\item \texttt{ScoreboardModel.php}
	\item \texttt{SettingsModel.php}
	\item \texttt{SubmitModel.php}
	\item \texttt{User.php}
	\item \texttt{UserModel.php}
\end{itemize}

Seluruh \textit{Model} akan diganti penamaannya dari yang sebelumnya menggunakan \textit{snakecase} menjadi \textit{camelcase}. Kode \ref{kode:modelbab4} merupakan perubahan sintaks yang terdapat pada \textit{model}.

\begin{lstlisting}[caption=Perancangan perubahan \textit{model} pada \textit{CodeIgniter 4}, label=kode:modelbab4]
namespace App\Models;

use App\Libraries\Parsedown;
use CodeIgniter\Model;
use App\Models\SettingsModel;
use App\Models\ScoreboardModel;

class AssignmentModel extends Model
{
	protected $settings_model;
	protected $scoreboard_model;
	protected $request;
	protected $parsedown;

	public function __construct()
	{
		parent::__construct();
		$this->settings_model = new SettingsModel();
		$this->request = \Config\Services::request(); 
	}

	/**
	 * Add New Assignment to DB / Edit Existing Assignment
	 *
	 * @param $id
	 * @param bool $edit
	 * @return bool
	 */
	public function add_assignment($id, $edit = FALSE)
	{	
		$this->scoreboard_model = new ScoreboardModel();
\end{lstlisting}

Kode \ref{kode:modelbab4} merupakan perubahan \textit{model} yang terdapat pada \textit{CodeIgniter 4}. Terdapat penghapusan sintaks \texttt{defined} dan juga terdapat perubahan dalam \textit{extends} dimana sekarang akan \textit{extends} \texttt{Model}. Selain itu terdapat pemanggilan \textit{model} lainnya menggunakan sintaks \texttt{new} yang disimpan melalui variabel yang sudah dibentuk. Selain itu, terdapat perubahan cara pengambilan data menggunakan \textit{query} yang dapat dilihat pada kode \ref{kode:modelqueryci4}.

\begin{lstlisting}[caption=Perubahan sintaks pada \textit{model}, label=kode:modelqueryci4]
	public function all_assignments()
	{
		$result = $this->db->table('assignments')->orderBy('id')->get()->getResultArray();
		$assignments = [];
		foreach ($result as $item)
		{
			$assignments[$item['id']] = $item;
		}
		return $assignments;
	}
\end{lstlisting}

Kode \ref{kode:modelqueryci4} merupakan perubahan sintaks untuk melakukan pengambilan data dari \textit{database}. Pengambilan data pada \textit{CodeIgniter 4} perlu melakukan definisi terhadap tabel mana yang akan diambil datanya. Selanjutnya sintaks akan bersifat sama namun terdapat perubahan dari yang sebelumnya \textit{snakecase} menjadi \textit{camelCase}. \textit{Model} yang telah dibentuk dapat dipanggil menuju \textit{contoller} menggunakan sintaks berikut.

\begin{center}
\verb|$this->settings_model = new SettingsModel();|
\end{center}

Sintaks diatas akan memanggil \textit{SettingsModel} dan disimpan menuju variabel.

\subsection{\textit{View}}
Direktori ini berisikan seluruh \textit{view} yang dipindahkan dari \textit{CodeIgniter 3}. Berikut merupakan isi dari direktori ini:
\subsubsection{errors}
\begin{itemize}
	\item \texttt{}
\end{itemize}
\subsubsection{pages}
\begin{itemize}
	\item \texttt{assignments.php}
	\item \texttt{dashboard.php}
	\item \texttt{halloffame.php}
	\item \texttt{notifications.php}
	\item \texttt{problems.php}
	\item \texttt{profile.php}
	\item \texttt{scoreboard\_table.php}
	\item \texttt{scoreboard.php}
	\item \texttt{submissions.php}
	\item \texttt{submit.php}
\end{itemize}
Direktori admin:
\begin{itemize}
	\item \texttt{add\_assignment.php}
	\item \texttt{add\_notification.php}
	\item \texttt{add\_user\_result.php}
	\item \texttt{add\_user.php}
	\item \texttt{delete\_assignment.php}
	\item \texttt{edit\_problem\_html.php}
	\item \texttt{edit\_problem\_md.php}
	\item \texttt{edit\_problem\_plain.php}
	\item \texttt{install.php}
	\item \texttt{logs.php}
	\item \texttt{moss.php}
	\item \texttt{queue.php}
	\item \texttt{rejudge.php}
	\item \texttt{settings.php}
	\item \texttt{users.php}
\end{itemize}
Direktori authentication:
\begin{itemize}
	\item \texttt{login.php}
	\item \texttt{lost.php}
	\item \texttt{register\_success.php}
	\item \texttt{register.php}
	\item \texttt{reset\_password.php}
\end{itemize}
Direktori templates:
\begin{itemize}
	\item \texttt{base.php}
	\item \texttt{side\_bar.php}
	\item \texttt{simple\_header.php}
	\item \texttt{top\_bar.php}
\end{itemize}

\textit{View} akan diubah menggunakan \textit{extension} \texttt{.php} sesuai pada dokumentasi \textit{CodeIgniter 4}. Seluruh \textit{file view} akan diubah menjadi \textit{extension} \texttt{.php} dari yang sebelumnya menggunakan \texttt{.twig}. Seluruh \textit{delimiters} juga akan diubah menggunakan fungsi pada \textit{CodeIgniter 4}. Perubahan \textit{view} dapat dilihat pada kode \ref{kode:loginViewBab4}.

\begin{lstlisting}[caption=Perubahan \textit{view} pada \textit{Login.php}, label=kode:loginViewBab4]
<!-- {#
 # SharIF Judge
 # file: login.twig
 # author: Mohammad Javad Naderi <mjnaderi@gmail.com>
 #} -->
<!DOCTYPE html>
<html lang="en">
<?= $this->include('templates/simple_header')?>

<?= form_open() ?>
	<div class="box login">

		<div class="judge_logo">
			<a href="<?= site_url() ?>"><img src="<?= base_url('assets/images/banner.png') ?>"/></a>
		</div>

		<div class="login_form">
			<div class="login1">
				<p>
					<label for="form_username">Username</label><br/>
					<input id="form_username" type="text" name="username" required="required" pattern="[0-9a-z]{3,20}" title="The Username field must be between 3 and 20 characters in length, and contain only digits and lowercase letters" class="sharif_input" value="<?= set_value('username') ?>" autofocus="autofocus"/>
					<?= isset($this->errors['username'])?>
				</p>
				<p>
					<label for="form_password">Password</label><br/>
					<input id="form_password" type="password" name="password" required="required" pattern=".{6,200}" title="The Password field must be at least 6 characters in length" class="sharif_input"/>
					<?= isset($this->errors['password'])?>
				</p>
				<?php if ($error): ?>
					<div class="shj_error">Incorrect username or password.</div>
				<?php endif ?>
			</div>
			<div class="login2">
				<p style="margin:0;">
					<?php if ($registration_enabled): ?>
					<a href="<?= site_url('register') ?>">Register</a> |
					<?php endif ?>
					<a href="<?= site_url('login/lost') ?>">Reset Password</a>
					<input type="submit" value="Login" id="sharif_submit"/>
				</p>
			</div>
		</div>

	</div>q
<?= form_close() ?>
</body>
</html>
\end{lstlisting}

Kode \ref{kode:loginViewBab4} merupakan perubahan yang terdapat pada halaman \textit{view}. \textit{Delimiters} \verb|{{ }}| akan digantikan menjadi \texttt{<?= ?>} sedangkan \verb|{% %}| akan digantikan menjadi \texttt{<?php ?>}. \textit{Delimiters} yang memanggil fungsi pada \textit{CodeIgniter 4} akan digantikan menjadi \texttt{<?= ?>}. Perubahan juga terdapat pada sintaks dari yang sebelumnya menggunakan \texttt{include} akan digantikan menggunakan fungsi \textit{CodeIgniter 4} berupa \verb|$this->include|. Selain terdapat perubahan \textit{extension} dan \textit{delimiters}, terdapat juga penambahan kode pada \textit{Controller} karena tidak mendukung pembentukan variabel \textit{global} pada \textit{View}. Kode \ref{kode:loginControllerViewBab4} merupakan contoh penambahan kode pada \textit{Controller}.

\begin{lstlisting}[caption=Penambahan kode pada \textit{Login.php}, label=kode:loginControllerViewBab4]
	$data = [
			'error' => FALSE,
			'registration_enabled' => $this->settings_model->get_setting('enable_registration'),
			'title' => 'Login',
			'validationError' => $this->validation
		];
\end{lstlisting}

Kode \ref{kode:loginControllerViewBab4} merupakan contoh penambahan data pada \textit{controller}. Penambahan data terjadi karena halaman \textit{view} PHP tidak dapat mendeklarasikan variabel secara \textit{global} sehingga data-data seperti \textit{title} tidak dapat diakses oleh \textit{view} lainnya.

\subsection{public}
	\subsubsection{assets}
	Direktori ini berisikan seluruh data yang dapat dilihat oleh pengguna seperti \textit{javascript}, gambar, dan lainnya. Berikut merupakan isi pada direktori ini:
	\begin{itemize}
		\item \texttt{ace}
		\item \texttt{font}
		\item \texttt{fullcalendar}
		\item \texttt{gridster}
		\item \texttt{images}
		\item \texttt{js}
		\item \texttt{nano\_scroller}
		\item \texttt{noty}
		\item \texttt{pdfjs}
		\item \texttt{reveal}
		\item \texttt{snippet}
		\item \texttt{styles}
		\item \texttt{tinymce}
	\end{itemize}

\subsection{restriced}
Direktori ini akan dipindah tanpa ada perubahan apapun.
